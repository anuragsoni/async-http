variables:
  GIT_DEPTH: "1"
  OPAMYES: "true"

image: ubuntu:19.10

cache:
  paths:
    - _opam

before_script:
  - apt update
  - apt install -y opam
  - opam init --bare --disable-sandboxing
  - eval $(opam env)
  - '[ ! -d "_opam" ] && opam switch create . 4.09.0 --no-install'
  - opam pin add async-http.dev -n .
  - opam depext async-http
  - opam install -t . --deps-only

build:
  stage: build
  script:
    - opam exec -- dune build

test:
  stage: test
  script:
    - opam exec -- dune runtest
